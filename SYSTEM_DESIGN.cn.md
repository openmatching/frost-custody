# FROST MPC 部署与威胁模型

## 你需要使用吗？

**大多数情况下并不需要。** 只有在程序化管理上千个地址时才有必要使用 FROST MPC。

| 使用场景                      | 推荐方案                   | 理由                         |
| ----------------------------- | -------------------------- | ---------------------------- |
| 个人资产管理                  | 硬件钱包（Ledger/Trezor）  | 简单易用，安全性经过验证     |
| 小团队（2-10 人）             | 多签钱包（2-of-3, 3-of-5） | 区块链原生支持，无需基础设施 |
| **交易所/托管（1000+ 用户）** | **FROST MPC**              | 程序化与门限安全的唯一方案   |

### 什么场景必须使用 FROST MPC

**典型场景：** 管理 5 万个用户充值地址

**硬件钱包的局限：**
- 无法生成 5 万个地址
- 无法实现自动签名，每次需要手动确认

**传统多签的问题：**
- 5 万用户需要管理 5 万个独立多签钱包
- 备份过于复杂（5 万份配置文件）
- 交易体积大（250 vB vs 110 vB），手续费成本高

**FROST MPC 的优势：**
- 每个用户一个口令对应一个地址
- 备份简单：只需 n 个主种子
- API 直接调用，实现完全自动化
- 门限安全（m-of-n 容错机制）
- 交易体积小（与单签相同）

**适用对象：** 加密货币交易所、托管钱包服务、支付处理商、机构级 DeFi

---

## 网络架构

### 三层安全防护体系

```
┌─────────────────────────────────────────────────┐
│ 第三层：地址生成器（端口 9000）                 │
│ - 负责地址生成（风险较低）                       │
│ - 可对外开放访问（配合限流措施）                 │
└──────────────┬──────────────────────────────────┘
               │
┌──────────────▼──────────────────────────────────┐
│ 第二层：签名聚合器（端口 8000）                 │
│ - 负责交易签名（风险较高）                       │
│ - 仅限内网访问，需通过 VPN，严格权限控制        │
└──────────────┬──────────────────────────────────┘
               │
┌──────────────▼──────────────────────────────────┐
│ 第一层：签名节点（核心层）                      │
│ - 节点 0、节点 1、节点 2、...                   │
│ - 每个节点部署在独立私有网络                     │
│ - 禁止外网访问，节点之间不直接通信               │
│ - 仅接受来自聚合器的请求                         │
└─────────────────────────────────────────────────┘
```

**设计原则：** 签名节点完全隔离，聚合器负责协调。

---

## 备份与恢复

### 需要备份的内容

**关键数据（丢失将导致资金无法找回）：**

**1. 主种子**

**存储方式：**

| 方式            | 成本            | 适用场景             |
| --------------- | --------------- | -------------------- |
| 明文配置        | $0              | 开发环境             |
| **PKCS#11/HSM** | **$55-5K/节点** | **生产环境（推荐）** |

PKCS#11 支持默认启用。支持 YubiKey ($55)、Thales、AWS CloudHSM 等任何 PKCS#11 设备。

配置：`frost-service/CONFIG_HSM.md` | 测试：`cargo xtask test-dkg --hsm`

**2. 门限配置**
   ```toml
   max_signers = n   # 节点总数（例如 3, 5, 24）
   min_signers = m   # 签名门限（例如 2, 3, 18）
   ```

**3. 用户口令列表**
   ```
   user_id → passphrase（任意字符串，建议使用高熵值）
   12345 → 550e8400-...  # UUID
   67890 → a3f5b9c2...   # hex
   99999 → 3J98t1Wp...   # base58
   ```

### 灾难恢复流程

```bash
# 1. 使用备份的主种子重新部署 n 个节点
# 2. 重新生成所有密钥
for passphrase in all_passphrases:
    POST /api/address/generate {"passphrase": "$passphrase"}

# 3. 验证生成的地址与历史记录一致
# 4. 恢复正常运营
```

**恢复时间：** 处理 1 万用户约需 1 小时（DKG 速度：每个地址 30-100ms）

**恢复结果：** 地址与密钥完全一致（确定性重新生成）

---

## 威胁模型

**假设采用 m-of-n 配置（例如 18-of-24）。以下分析适用于任意门限配置。**

### 威胁矩阵

| 被攻破组件        | 能否生成地址 | 能否签名 | 资金风险       | 应对措施       |
| ----------------- | ------------ | -------- | -------------- | -------------- |
| 少于 m 个节点数据 | 否           | 否       | ✅ 安全         | 监控观察       |
| 达到 m 个节点数据 | 否           | 是*      | ⚠️ **危急**     | 立即转移资金   |
| 少于 n 个主种子   | 否           | 否       | ✅ 安全         | 安全审计       |
| 全部 n 个主种子   | 是           | 是       | ❌ **全部失守** | 紧急转移       |
| 地址生成器被攻破  | 是           | 否       | ✅ 安全         | 影响较小       |
| 签名聚合器被攻破  | 否           | 是*      | ⚠️ 视情况而定   | 取决于口令强度 |

**\* 需要获取口令** - 高熵口令（UUID）相对安全，低熵口令（1,2,3...）风险极高

### 关键概念：节点数据与主种子的区别

**节点数据 = RocksDB 中存储的特定口令密钥分片**
- 攻破 ≥m 个节点 → 仅能为已存在的口令签名
- 影响范围：限于数据库中已有的口令

**主种子 = 根密钥**
- 攻破全部 n 个种子 → 可推导任意口令的完整密钥
- 影响范围：所有历史及未来的密钥均受影响

---

## 具体威胁场景

### 1. 少数节点数据泄露（少于 m 个）

**示例：** 18-of-24 配置中 5 个节点被攻破

**影响评估：** ✅ 资金安全（需要 18 个节点才能完成签名）

**处理措施：** 持续监控，对被攻破节点进行安全审计

---

### 2. 达到门限的节点数据泄露（≥ m 个）

**示例：** 18-of-24 配置中 18 个或以上节点被攻破

**影响评估：** ⚠️ **风险极高**（如果口令同时泄露）

**处理措施根据口令强度而定：**

**高熵口令（UUID、256 位随机数）：**
- 攻击者无法推测口令 → 无需立即转移
- 加强监控异常交易活动

**低熵口令（顺序数字如 1, 2, 3）：**
- 攻击者可以枚举尝试 → **立即执行转移**
- 紧急关闭签名聚合器
- 将所有资金转移至新系统

**现实限制：** 系统不支持密钥轮换，必须通过链上交易转移资金。

---

### 3. 部分主种子泄露（少于 n 个）

**示例：** 24 个种子中有 20 个泄露

**影响评估：** ✅ 资金安全（DKG 算法需要全部种子参与）

**安全原理：** 缺少任何一个种子，生成的密钥将完全不同

**处理措施：** 进行安全审计，无需转移资金

---

### 4. 全部主种子泄露（n 个全部）

**影响评估：** ❌ **系统完全失守**

**攻击者能力：** 可推导任意口令对应的完整密钥

**应急措施：** 与攻击者竞速，抢先将所有资金转移至安全地址

**预防措施：**
- 将种子存储在 HSM 或硬件钱包中
- 采用 Shamir 密钥分片（每个种子 3-of-5 分割）
- 实施地理分散存储

---

### 5. 聚合器被攻破

**地址生成器被攻破：**
- 可以生成地址（造成隐私泄露）
- 无法签署交易
- 风险相对较低

**签名聚合器被攻破：**
- 可以发起签名请求（但仍需口令）
- 若口令可被推测则风险极高
- 需要根据口令强度评估风险

---

### 6. 种子备份丢失

**影响评估：** ⚠️ **资金永久无法找回**

**具体后果：**
- 无法重新生成密钥
- 无法签署任何交易
- 资金永久锁定

**预防措施：**
- 务必备份全部主种子
- 每季度进行恢复演练
- 实施多地点冗余备份

---

## 口令安全策略

**系统对口令格式无限制，接受任意字符串。** 但口令强度是关键的第二道防线。

### 推荐方案（高强度）

```python
# ✅ 推荐使用以下方案之一

uuid.uuid4()                    # 128 位 UUID
secrets.token_hex(32)           # 256 位十六进制
base58.b58encode(secrets.token_bytes(32))  # 256 位 base58
hashlib.sha256(f"{user_id}:{SECRET_SALT}")  # 加盐哈希
```

**安全强度：** 2^128 到 2^256 密钥空间，攻击者无法枚举

### 不安全方案（低强度）

```python
# ❌ 生产环境严禁使用

str(user_id)              # "12345" - 攻击者可顺序尝试
f"user_{user_id}"         # "user_12345" - 仍为顺序可预测
f"wallet-{counter}"       # "wallet-1" - 模式可预测
```

**安全强度：** 顺序或可预测模式 → 攻击者可遍历所有用户

### 口令强度的重要性

当 ≥m 个节点数据被攻破时：

| 口令类型        | 攻击者能否签名   |
| --------------- | ---------------- |
| 高强度（UUID）  | ❌ 否（无法推测） |
| 低强度（1,2,3） | ✅ 是（可枚举）   |

---

## 运维建议

### 门限配置方案

| 部署环境 | 推荐配置             | 容错能力              |
| -------- | -------------------- | --------------------- |
| 开发测试 | 2-of-3               | 可容忍 1 个节点故障   |
| 生产环境 | 3-of-5 或 5-of-7     | 可容忍 2-4 个节点故障 |
| 企业级   | 10-of-15 或 18-of-24 | 可容忍 5-8 个节点故障 |

**配置原则：**
- `m ≤ 2n/3`（满足拜占庭容错要求）
- `n - m ≥ 2`（保证一定容错余地）

### 监控要求

- 记录所有签名请求
- 对异常模式进行告警（频率、金额、目标地址）
- 实施地理位置异常检测

### 应急响应

- 明确资金转移的触发条件
- 预先准备冷钱包地址
- 制定用户沟通方案

### 定期演练

- 每季度进行渗透测试
- 每季度演练灾难恢复流程（验证种子备份的有效性）

---

## 硬件安全（PKCS#11）

**PKCS#11 支持默认启用** - 支持任何兼容设备。

**支持设备：**
- SoftHSM（免费，测试）- `cargo xtask test-dkg --hsm`
- YubiKey（$55，USB 令牌）
- Thales HSM（$5K+，企业级）
- AWS CloudHSM（$1K/月，云端）

**配置示例：**
```toml
[node.key_provider]
type = "pkcs11"
pkcs11_library = "/usr/lib/libykcs11.so"  # 根据设备选择
pin = "${HSM_PIN}"
key_label = "frost-node-0"
```

**Docker 镜像：**
- `Dockerfile` - 生产环境（精简，~150MB）
- `Dockerfile.softhsm` - 测试环境（包含 SoftHSM，~200MB）

配置详情：`frost-service/CONFIG_HSM.md` | 测试指南：`hsm/README.md`

---

## 总结

**安全保障：**
1. 门限机制（≥m 个节点）
2. 高强度口令
3. 网络隔离
4. HSM 硬件保护（PKCS#11）

**系统限制：**
- 无密钥轮换（需链上迁移）
- ≥m 节点被攻破需紧急转移

**灵活性：**
- 任意 m-of-n 配置（2-of-3 到 18-of-24+）
- 任意 PKCS#11 设备
- 明文或硬件保护可选
