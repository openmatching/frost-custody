# FROST DKG Latency Test: 16-of-24 Threshold
# 
# Auto-generated by: cargo xtask gen-configs --nodes 24 --threshold 16
# 
# Architecture:
#   - 24 internal signer nodes (no exposed ports)
#   - 1 address aggregator (exposed port 9100)
#   - Client connects only to aggregator
#
# Performance:
#   First run:  ~900ms (generates SoftHSM keys)
#   Subsequent: ~900ms (reuses cached keys from volumes)
#   
#   To reset keys: docker-compose -f tests/docker-compose.test.yml down -v
#
# Usage:
#   cargo xtask test-dkg

services:
  # 24 FROST Signer Nodes (internal only, no exposed ports)

  frost-node-00:
    image: frost-mpc:latest
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: frost-test-node-00
    command: ["frost-service"]
    environment:
      - RUST_LOG=error
      - NODE_INDEX=0
    volumes:
      - ./configs/node-00.toml:/etc/config.toml:ro
      - frost-test-data-00:/data
      - frost-test-softhsm-00:/var/lib/softhsm/tokens  # Cache HSM keys between runs
    networks:
      - frost-test-internal


  frost-node-01:
    image: frost-mpc:latest
    container_name: frost-test-node-01
    command: ["frost-service"]
    environment:
      - RUST_LOG=error
      - NODE_INDEX=1
    volumes:
      - ./configs/node-01.toml:/etc/config.toml:ro
      - frost-test-data-01:/data
      - frost-test-softhsm-01:/var/lib/softhsm/tokens  # Cache HSM keys between runs
    networks:
      - frost-test-internal


  frost-node-02:
    image: frost-mpc:latest
    container_name: frost-test-node-02
    command: ["frost-service"]
    environment:
      - RUST_LOG=error
      - NODE_INDEX=2
    volumes:
      - ./configs/node-02.toml:/etc/config.toml:ro
      - frost-test-data-02:/data
      - frost-test-softhsm-02:/var/lib/softhsm/tokens  # Cache HSM keys between runs
    networks:
      - frost-test-internal


  frost-node-03:
    image: frost-mpc:latest
    container_name: frost-test-node-03
    command: ["frost-service"]
    environment:
      - RUST_LOG=error
      - NODE_INDEX=3
    volumes:
      - ./configs/node-03.toml:/etc/config.toml:ro
      - frost-test-data-03:/data
      - frost-test-softhsm-03:/var/lib/softhsm/tokens  # Cache HSM keys between runs
    networks:
      - frost-test-internal


  frost-node-04:
    image: frost-mpc:latest
    container_name: frost-test-node-04
    command: ["frost-service"]
    environment:
      - RUST_LOG=error
      - NODE_INDEX=4
    volumes:
      - ./configs/node-04.toml:/etc/config.toml:ro
      - frost-test-data-04:/data
      - frost-test-softhsm-04:/var/lib/softhsm/tokens  # Cache HSM keys between runs
    networks:
      - frost-test-internal


  frost-node-05:
    image: frost-mpc:latest
    container_name: frost-test-node-05
    command: ["frost-service"]
    environment:
      - RUST_LOG=error
      - NODE_INDEX=5
    volumes:
      - ./configs/node-05.toml:/etc/config.toml:ro
      - frost-test-data-05:/data
      - frost-test-softhsm-05:/var/lib/softhsm/tokens  # Cache HSM keys between runs
    networks:
      - frost-test-internal


  frost-node-06:
    image: frost-mpc:latest
    container_name: frost-test-node-06
    command: ["frost-service"]
    environment:
      - RUST_LOG=error
      - NODE_INDEX=6
    volumes:
      - ./configs/node-06.toml:/etc/config.toml:ro
      - frost-test-data-06:/data
      - frost-test-softhsm-06:/var/lib/softhsm/tokens  # Cache HSM keys between runs
    networks:
      - frost-test-internal


  frost-node-07:
    image: frost-mpc:latest
    container_name: frost-test-node-07
    command: ["frost-service"]
    environment:
      - RUST_LOG=error
      - NODE_INDEX=7
    volumes:
      - ./configs/node-07.toml:/etc/config.toml:ro
      - frost-test-data-07:/data
      - frost-test-softhsm-07:/var/lib/softhsm/tokens  # Cache HSM keys between runs
    networks:
      - frost-test-internal


  frost-node-08:
    image: frost-mpc:latest
    container_name: frost-test-node-08
    command: ["frost-service"]
    environment:
      - RUST_LOG=error
      - NODE_INDEX=8
    volumes:
      - ./configs/node-08.toml:/etc/config.toml:ro
      - frost-test-data-08:/data
      - frost-test-softhsm-08:/var/lib/softhsm/tokens  # Cache HSM keys between runs
    networks:
      - frost-test-internal


  frost-node-09:
    image: frost-mpc:latest
    container_name: frost-test-node-09
    command: ["frost-service"]
    environment:
      - RUST_LOG=error
      - NODE_INDEX=9
    volumes:
      - ./configs/node-09.toml:/etc/config.toml:ro
      - frost-test-data-09:/data
      - frost-test-softhsm-09:/var/lib/softhsm/tokens  # Cache HSM keys between runs
    networks:
      - frost-test-internal


  frost-node-10:
    image: frost-mpc:latest
    container_name: frost-test-node-10
    command: ["frost-service"]
    environment:
      - RUST_LOG=error
      - NODE_INDEX=10
    volumes:
      - ./configs/node-10.toml:/etc/config.toml:ro
      - frost-test-data-10:/data
      - frost-test-softhsm-10:/var/lib/softhsm/tokens  # Cache HSM keys between runs
    networks:
      - frost-test-internal


  frost-node-11:
    image: frost-mpc:latest
    container_name: frost-test-node-11
    command: ["frost-service"]
    environment:
      - RUST_LOG=error
      - NODE_INDEX=11
    volumes:
      - ./configs/node-11.toml:/etc/config.toml:ro
      - frost-test-data-11:/data
      - frost-test-softhsm-11:/var/lib/softhsm/tokens  # Cache HSM keys between runs
    networks:
      - frost-test-internal


  frost-node-12:
    image: frost-mpc:latest
    container_name: frost-test-node-12
    command: ["frost-service"]
    environment:
      - RUST_LOG=error
      - NODE_INDEX=12
    volumes:
      - ./configs/node-12.toml:/etc/config.toml:ro
      - frost-test-data-12:/data
      - frost-test-softhsm-12:/var/lib/softhsm/tokens  # Cache HSM keys between runs
    networks:
      - frost-test-internal


  frost-node-13:
    image: frost-mpc:latest
    container_name: frost-test-node-13
    command: ["frost-service"]
    environment:
      - RUST_LOG=error
      - NODE_INDEX=13
    volumes:
      - ./configs/node-13.toml:/etc/config.toml:ro
      - frost-test-data-13:/data
      - frost-test-softhsm-13:/var/lib/softhsm/tokens  # Cache HSM keys between runs
    networks:
      - frost-test-internal


  frost-node-14:
    image: frost-mpc:latest
    container_name: frost-test-node-14
    command: ["frost-service"]
    environment:
      - RUST_LOG=error
      - NODE_INDEX=14
    volumes:
      - ./configs/node-14.toml:/etc/config.toml:ro
      - frost-test-data-14:/data
      - frost-test-softhsm-14:/var/lib/softhsm/tokens  # Cache HSM keys between runs
    networks:
      - frost-test-internal


  frost-node-15:
    image: frost-mpc:latest
    container_name: frost-test-node-15
    command: ["frost-service"]
    environment:
      - RUST_LOG=error
      - NODE_INDEX=15
    volumes:
      - ./configs/node-15.toml:/etc/config.toml:ro
      - frost-test-data-15:/data
      - frost-test-softhsm-15:/var/lib/softhsm/tokens  # Cache HSM keys between runs
    networks:
      - frost-test-internal


  frost-node-16:
    image: frost-mpc:latest
    container_name: frost-test-node-16
    command: ["frost-service"]
    environment:
      - RUST_LOG=error
      - NODE_INDEX=16
    volumes:
      - ./configs/node-16.toml:/etc/config.toml:ro
      - frost-test-data-16:/data
      - frost-test-softhsm-16:/var/lib/softhsm/tokens  # Cache HSM keys between runs
    networks:
      - frost-test-internal


  frost-node-17:
    image: frost-mpc:latest
    container_name: frost-test-node-17
    command: ["frost-service"]
    environment:
      - RUST_LOG=error
      - NODE_INDEX=17
    volumes:
      - ./configs/node-17.toml:/etc/config.toml:ro
      - frost-test-data-17:/data
      - frost-test-softhsm-17:/var/lib/softhsm/tokens  # Cache HSM keys between runs
    networks:
      - frost-test-internal


  frost-node-18:
    image: frost-mpc:latest
    container_name: frost-test-node-18
    command: ["frost-service"]
    environment:
      - RUST_LOG=error
      - NODE_INDEX=18
    volumes:
      - ./configs/node-18.toml:/etc/config.toml:ro
      - frost-test-data-18:/data
      - frost-test-softhsm-18:/var/lib/softhsm/tokens  # Cache HSM keys between runs
    networks:
      - frost-test-internal


  frost-node-19:
    image: frost-mpc:latest
    container_name: frost-test-node-19
    command: ["frost-service"]
    environment:
      - RUST_LOG=error
      - NODE_INDEX=19
    volumes:
      - ./configs/node-19.toml:/etc/config.toml:ro
      - frost-test-data-19:/data
      - frost-test-softhsm-19:/var/lib/softhsm/tokens  # Cache HSM keys between runs
    networks:
      - frost-test-internal


  frost-node-20:
    image: frost-mpc:latest
    container_name: frost-test-node-20
    command: ["frost-service"]
    environment:
      - RUST_LOG=error
      - NODE_INDEX=20
    volumes:
      - ./configs/node-20.toml:/etc/config.toml:ro
      - frost-test-data-20:/data
      - frost-test-softhsm-20:/var/lib/softhsm/tokens  # Cache HSM keys between runs
    networks:
      - frost-test-internal


  frost-node-21:
    image: frost-mpc:latest
    container_name: frost-test-node-21
    command: ["frost-service"]
    environment:
      - RUST_LOG=error
      - NODE_INDEX=21
    volumes:
      - ./configs/node-21.toml:/etc/config.toml:ro
      - frost-test-data-21:/data
      - frost-test-softhsm-21:/var/lib/softhsm/tokens  # Cache HSM keys between runs
    networks:
      - frost-test-internal


  frost-node-22:
    image: frost-mpc:latest
    container_name: frost-test-node-22
    command: ["frost-service"]
    environment:
      - RUST_LOG=error
      - NODE_INDEX=22
    volumes:
      - ./configs/node-22.toml:/etc/config.toml:ro
      - frost-test-data-22:/data
      - frost-test-softhsm-22:/var/lib/softhsm/tokens  # Cache HSM keys between runs
    networks:
      - frost-test-internal


  frost-node-23:
    image: frost-mpc:latest
    container_name: frost-test-node-23
    command: ["frost-service"]
    environment:
      - RUST_LOG=error
      - NODE_INDEX=23
    volumes:
      - ./configs/node-23.toml:/etc/config.toml:ro
      - frost-test-data-23:/data
      - frost-test-softhsm-23:/var/lib/softhsm/tokens  # Cache HSM keys between runs
    networks:
      - frost-test-internal


  # Address Aggregator - Single public endpoint
  address-aggregator:
    image: frost-mpc:latest
    container_name: frost-test-aggregator
    entrypoint: ["frost-service"]
    environment:
      - RUST_LOG=info
    volumes:
      - ./configs/aggregator.toml:/etc/config.toml:ro
    ports:
      - "9100:9100"  # Only this port is exposed
    networks:
      - frost-test-internal
      - frost-test-public
    depends_on:
      - frost-node-00
      - frost-node-01
      - frost-node-02
      - frost-node-03
      - frost-node-04
      - frost-node-05
      - frost-node-06
      - frost-node-07
      - frost-node-08
      - frost-node-09
      - frost-node-10
      - frost-node-11
      - frost-node-12
      - frost-node-13
      - frost-node-14
      - frost-node-15
      - frost-node-16
      - frost-node-17
      - frost-node-18
      - frost-node-19
      - frost-node-20
      - frost-node-21
      - frost-node-22
      - frost-node-23

networks:
  frost-test-internal:
    driver: bridge
    internal: true  # Signer nodes isolated from external access
  frost-test-public:
    driver: bridge  # Only aggregator accessible

volumes:
  frost-test-data-00:
  frost-test-softhsm-00:  # Cached HSM keys
  frost-test-data-01:
  frost-test-softhsm-01:  # Cached HSM keys
  frost-test-data-02:
  frost-test-softhsm-02:  # Cached HSM keys
  frost-test-data-03:
  frost-test-softhsm-03:  # Cached HSM keys
  frost-test-data-04:
  frost-test-softhsm-04:  # Cached HSM keys
  frost-test-data-05:
  frost-test-softhsm-05:  # Cached HSM keys
  frost-test-data-06:
  frost-test-softhsm-06:  # Cached HSM keys
  frost-test-data-07:
  frost-test-softhsm-07:  # Cached HSM keys
  frost-test-data-08:
  frost-test-softhsm-08:  # Cached HSM keys
  frost-test-data-09:
  frost-test-softhsm-09:  # Cached HSM keys
  frost-test-data-10:
  frost-test-softhsm-10:  # Cached HSM keys
  frost-test-data-11:
  frost-test-softhsm-11:  # Cached HSM keys
  frost-test-data-12:
  frost-test-softhsm-12:  # Cached HSM keys
  frost-test-data-13:
  frost-test-softhsm-13:  # Cached HSM keys
  frost-test-data-14:
  frost-test-softhsm-14:  # Cached HSM keys
  frost-test-data-15:
  frost-test-softhsm-15:  # Cached HSM keys
  frost-test-data-16:
  frost-test-softhsm-16:  # Cached HSM keys
  frost-test-data-17:
  frost-test-softhsm-17:  # Cached HSM keys
  frost-test-data-18:
  frost-test-softhsm-18:  # Cached HSM keys
  frost-test-data-19:
  frost-test-softhsm-19:  # Cached HSM keys
  frost-test-data-20:
  frost-test-softhsm-20:  # Cached HSM keys
  frost-test-data-21:
  frost-test-softhsm-21:  # Cached HSM keys
  frost-test-data-22:
  frost-test-softhsm-22:  # Cached HSM keys
  frost-test-data-23:
  frost-test-softhsm-23:  # Cached HSM keys
