# DKG Latency Test

Performance test for FROST threshold signatures with configurable node counts.

## Quick Start

```bash
cargo xtask test-dkg
```

See main [README.md](../README.md) for general usage, API reference, and command reference.

## Test Configuration

The test is configurable for different thresholds:

```bash
# 2-of-3 (development)
cargo xtask gen-configs --nodes 3 --threshold 2

# 7-of-10 (small production)
cargo xtask gen-configs --nodes 10 --threshold 7

# 16-of-24 (enterprise)
cargo xtask gen-configs --nodes 24 --threshold 16
```

## Architecture

```
Client (dkg_latency_test)
    │
    ▼ POST /api/address/generate
Address Aggregator (port 9100)
    │ Orchestrates DKG
    ├─────────┬─────────┬─────────┐
    ▼         ▼         ▼         ▼
[Node 0] [Node 1] ... [Node N-1]
internal internal     internal
```

- Signer nodes: Internal network only
- Aggregator: Single exposed port (9100)
- DKG: 3-round protocol (commit, share, finalize)

## Expected Performance

Local Docker (measured):

| Nodes | Threshold | Latency (single address) | Test Status |
| ----- | --------- | ------------------------ | ----------- |
| 3     | 2         | ~80ms                    | Estimated   |
| 10    | 7         | ~150ms                   | Estimated   |
| 24    | 16        | **32ms**                 | ✅ Measured  |

**Actual test results (16-of-24):**
- Run 1: 40.99ms
- Run 2: 25.87ms  
- Run 3: 29.58ms
- Average: **32ms latency**

**Note:** Since each DKG is independent, you can run multiple requests concurrently for much higher throughput (10+ concurrent requests = 300+ addr/sec).

Production (with network latency):
- Same datacenter: +50-200ms per address
- Multi-datacenter: +200-1000ms per address
- Global distribution: +1000-3000ms per address

## Configuration Files

Auto-generated by `cargo xtask gen-configs`:

**Node config** (`tests/configs/node-XX.toml`):
```toml
[server]
role = "node"
host = "0.0.0.0"
port = 4000

[node]
index = 0
master_seed_hex = "..."  # Random for testing
storage_path = "/data/node0"
max_signers = 24
min_signers = 16
```

**Aggregator config** (`tests/configs/aggregator.toml`):
```toml
[aggregator]
signer_nodes = [
    "http://frost-test-node-00:4000",
    ...
]
threshold = 16
```

**Docker compose** (`tests/docker-compose.test.yml`):
- Dynamically generated based on node count
- Internal network for signers
- Public network for aggregator only

## Troubleshooting

**Test times out:**
```bash
# Check aggregator
curl http://127.0.0.1:9100/docs

# Check logs
docker logs frost-test-aggregator
```

**Containers won't start:**
```bash
# Rebuild
docker-compose -f tests/docker-compose.test.yml build --no-cache

# Check status
docker ps -a | grep frost-test
```

**Port conflicts:**
Edit `tests/configs/aggregator.toml` to change port 9100.

## Understanding Results

### Good Performance Indicators
- ✅ Consistent timing across runs (±10%)
- ✅ Throughput scales with parallelism
- ✅ No timeout errors

### Red Flags
- ❌ High variance between runs → Resource contention
- ❌ Timeouts → Network issues or node crashes
- ❌ Errors in logs → Configuration problems

## Related Documentation

- [Main README](../README.md) - Project overview, examples, API reference, commands
- [xtask/README.md](../xtask/README.md) - Task runner details
- [dkg-latency/README.md](dkg-latency/README.md) - Test implementation details
